# Выбираем версию ETCD
ETCD_VER=v3.5.17
 
# Выбираем источник закачки
GOOGLE_URL=https://storage.googleapis.com/etcd
GITHUB_URL=https://github.com/coreos/etcd/releases/download
DOWNLOAD_URL=${GOOGLE_URL}
 
#Задает основные переменные
#Задаем ноду кластера (1-3)
ETCD_NODE_NUMBER=1
#Задаем адреса нод
ETCD_NODE_IP_1=10.29.0.70
ETCD_NODE_IP_2=10.29.0.241
ETCD_NODE_IP_3=10.29.0.242
ETCD_THIS_NODE_IP=10.29.0.70
 
#Останавливаем и удаляем старую службу
sudo systemctl stop etcd.service
sudo systemctl disable etcd.service
sudo rm -f /etc/systemd/system/etcd.service
 
#Удаляем старые файлы и папки
sudo rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
sudo rm -rf /tmp/etcd
sudo rm -rf /tmp/test-etcd
sudo rm -rf /app/etcd
 
#Добавляем группу и пользователя etcd
sudo groupadd etcd
sudo useradd -g etcd etcd
 
#Скачиваем, распаковываем и устанавливаем
mkdir -p /tmp/test-etcd
curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/test-etcd --strip-components=1
sudo mkdir -p  /app/etcd
sudo chown -R etcd:etcd /app/etcd
sudo chmod 777 /app/etcd
sudo cp /tmp/test-etcd/etcd* /app/etcd
 
#Создаем файл конфигурации ETCD
cat > /app/etcd/etcd.conf <<ENDOFFILE
ETCD_NAME=etcd${ETCD_NODE_NUMBER}
ETCD_DATA_DIR=/app/etcd
ETCD_LISTEN_CLIENT_URLS=http://${ETCD_THIS_NODE_IP}:2379
ETCD_ADVERTISE_CLIENT_URLS=http://${ETCD_THIS_NODE_IP}:2379
ETCD_LISTEN_PEER_URLS=http://${ETCD_THIS_NODE_IP}:2380
ETCD_INITIAL_ADVERTISE_PEER_URLS=http://${ETCD_THIS_NODE_IP}:2380
ETCD_INITIAL_CLUSTER=etcd1=http://${ETCD_NODE_IP_1}:2380,etcd2=http://${ETCD_NODE_IP_2}:2380,etcd3=http://${ETCD_NODE_IP_3}:2380
ETCD_INITIAL_CLUSTER_TOKEN=etcd_cluster_token111
ETCD_INITIAL_CLUSTER_STATE=new
ENDOFFILE
 
#Создаем файл UNIT ETCD
cat > /app/etcd/etcd.service <<ENDOFFILE
[Unit]
Description=etcd - highly-available key value store
Documentation=https://etcd.io/docs
Documentation=man:etcd
After=network.target
Wants=network-online.target
 
[Service]
User=etcd
Type=notify
Environment=ETCD_DATA_DIR=/app/etcd
Environment=ETCD_NAME=%H
EnvironmentFile=/app/etcd/etcd.conf
ExecStart=/app/etcd/etcd
Restart=always
RestartSec=10s
LimitNOFILE=40000
 
[Install]
WantedBy=multi-user.target
Alias=etcdstart.service
ENDOFFILE
 
sudo chown -R etcd:etcd /app/etcd/*
sudo chmod 777 /app/etcd/*
 
sudo cp /app/etcd/etcd.service /etc/systemd/system
 
#Добавляем сервис в автозапуск
sudo systemctl enable etcd.service